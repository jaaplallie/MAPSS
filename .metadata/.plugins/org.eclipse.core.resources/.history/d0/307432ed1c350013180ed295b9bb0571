package Gui;

import javax.swing.*;

import java.awt.*;
import java.awt.List;
import java.awt.image.*;
import java.io.*;
import java.util.*;
import java.util.Map.Entry;

import javax.imageio.*;
import org.jfree.chart.*;
import org.jfree.data.category.*;
import org.jfree.data.general.*;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;
import com.jgoodies.forms.layout.FormLayout;
import com.jgoodies.forms.layout.ColumnSpec;
import com.jgoodies.forms.factories.FormFactory;
import com.jgoodies.forms.layout.RowSpec;

public class ChartPresenter extends JPanel implements ActionListener{
	private static final long serialVersionUID = 6423561811886542809L;
	
	JSplitPane splitPane = new JSplitPane();
	JPanel chartPanel = new JPanel();
	JPanel controlPanel = new JPanel();
	JPanel formContainer = new JPanel();
	JComboBox<String> chartComboBox = new JComboBox<String>();
	Map<Integer, String> chartNamingDictionary = new HashMap<Integer, String>();
	Map<Integer, JFreeChart> chartObjectDictionary = new HashMap<Integer, JFreeChart>();
	ChartPanel chartContainer = new ChartPanel(null);
	private final Choice saveAsChoice = new Choice();
	
	public ChartPresenter(){
		add(splitPane);
		splitPane.setLeftComponent(chartPanel);
		splitPane.setRightComponent(controlPanel);
		chartPanel.add(chartContainer);
		GridBagLayout gbl_controlPanel = new GridBagLayout();
		gbl_controlPanel.columnWidths = new int[]{200, 0};
		gbl_controlPanel.rowHeights = new int[]{0, 0, 0, 5, 0, 20, 0};
		gbl_controlPanel.columnWeights = new double[]{0.0, Double.MIN_VALUE};
		gbl_controlPanel.rowWeights = new double[]{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, Double.MIN_VALUE};
		controlPanel.setLayout(gbl_controlPanel);
		chartComboBox.addActionListener(this);
		GridBagConstraints gbc_chartComboBox = new GridBagConstraints();
		gbc_chartComboBox.insets = new Insets(0, 0, 5, 0);
		gbc_chartComboBox.anchor = GridBagConstraints.NORTH;
		gbc_chartComboBox.fill = GridBagConstraints.HORIZONTAL;
		gbc_chartComboBox.gridx = 0;
		gbc_chartComboBox.gridy = 0;
		controlPanel.add(chartComboBox, gbc_chartComboBox);
		Label label = new Label("Save as:");
		GridBagConstraints gbc_label = new GridBagConstraints();
		gbc_label.insets = new Insets(0, 0, 5, 0);
		gbc_label.gridx = 0;
		gbc_label.gridy = 1;
		controlPanel.add(label, gbc_label);
		GridBagConstraints gbc_saveAsChoice = new GridBagConstraints();
		gbc_saveAsChoice.insets = new Insets(0, 0, 5, 0);
		gbc_saveAsChoice.gridx = 0;
		gbc_saveAsChoice.gridy = 2;
		controlPanel.add(saveAsChoice, gbc_saveAsChoice);
		
		saveAsChoice.setVisible(true);
		saveAsChoice.add("PNG");
		saveAsChoice.add("JPEG");
		GridBagConstraints gbc_formContainer = new GridBagConstraints();
		gbc_formContainer.fill = GridBagConstraints.BOTH;
		gbc_formContainer.insets = new Insets(0, 0, 5, 0);
		gbc_formContainer.gridx = 0;
		gbc_formContainer.gridy = 3;
		controlPanel.add(formContainer, gbc_formContainer);
		
		formContainer.setLayout(new FormLayout(new ColumnSpec[] {
				FormFactory.LABEL_COMPONENT_GAP_COLSPEC,
				ColumnSpec.decode("200px"),},
			new RowSpec[] {
				FormFactory.LINE_GAP_ROWSPEC,
				RowSpec.decode("50px"),}));
	}
	
	public void addChart(JFreeChart chart){
		int new_key = chartNamingDictionary.size() + 1;
		String chartTitle = chart.getTitle().getText();
		chartNamingDictionary.put(new_key, chartTitle);
		chartObjectDictionary.put(new_key, chart);
		chartComboBox.addItem(chartTitle);
		reload();
	}
	
	public void reload(){
		chartComboBox.removeAllItems();
		for(Entry<Integer, String> entry : chartNamingDictionary.entrySet()){
			chartComboBox.addItem(entry.getValue());
		}
		validate();
		System.out.println("ChartPresenter reloaded.");
	}
	
	public void empty(){
		chartNamingDictionary.clear();
		chartObjectDictionary.clear();
		chartComboBox.removeAllItems();
		validate();
		System.out.println("ChartPresenter emptied.");
	}

	@Override
	public void actionPerformed(ActionEvent e) {
        if(e.getSource().equals(chartComboBox)){
        	@SuppressWarnings("unchecked")
			JComboBox<String> cb = (JComboBox<String>)e.getSource();
        	for(Entry<Integer, String> entry : chartNamingDictionary.entrySet()){
        		if(entry.getValue() == (String)cb.getSelectedItem()){
        			JFreeChart selectedChart = chartObjectDictionary.get(entry.getKey());
        			chartContainer.setChart(selectedChart);
        			validate();
        			break;
        		}
    		}
        	
        }
	}
}
